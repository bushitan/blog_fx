<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />

    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/gallery.css" rel="stylesheet">
    <title>私密画廊</title>
</head>
<script src="/static/jquery/jquery-2.1.3.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<body>

{#{% for g in gallery%}#}
{#    <p>{{ g.user }}</p>#}
{#    <p><b>你的画廊</b></p>#}
{#    <p>#}
{#       {{ g.create_time }}#}
{#    </p>#}
{#    <p style="width:100%;height: auto">#}
{#        <a>#}
{##}
{#            <img src="{{ g.img_url }}" style="width:49%;height: auto">#}
{#        </a>#}
{#        <a>#}
{##}
{#            <img src="{{ g.char_img_url }}" style="width:49%;height: auto">#}
{#        </a>#}
{#    </p>#}
{#    <br>#}
{##}
{#{% endfor %}#}


<div class="container">
        <style>
			ul.timeline {
				list-style-type: none;
{#				background: url("http://fineui.com/res/img/version_line.png") repeat-y scroll 120px 0 transparent;#}
				background: url("/static/img/color_grid.png") repeat-y scroll 0px 0 transparent;
{#                background-position:-62px -32px;#}
{#                overflow:hidden#}
{#				margin: 50px 0;#}
				padding: 0;
                margin: 0;
			}

			ul.timeline li {
				position: relative;
{#                background-color: #FFFFFF;#}
{#                left: 60px;#}
{#				margin-bottom: 20px;#}
			}
			ul.timeline li .time {
				position: absolute;
				width: 200px;
				text-align: left;
				left: 60px;
				top: 30px;
				color: #999;
				font-size: 10px;
{#                border-bottom: 1px solid black;;#}
			}
			ul.timeline li .version {
				position: absolute;
				width: 100%;
				text-align: right;
{#				left: -200px;#}
				top: 35px;
				font-size: 40px;
				line-height: 50px;
				color: #3594cb;
				overflow: hidden;
			}
			ul.timeline li .number {
				position: absolute;
				background: url("/static/img/color_line.jpg")  repeat-y scroll 0 0 transparent;
{#                background-position:-162px -32px;#}
                border-radius:18px;
				width: 18px;
				height: 18px;
				left: 27px;
                top:26px;
				line-height: 20px;
				text-align: center;
				color: #fff;
				font-size: 11px;
			}
			ul.timeline li.alt .number {
				background-image: url("http://fineui.com/res/img/version_dot_alt.png");

			}

			ul.timeline li .content {
{#				margin-left: 10px;#}
                padding: 20px 0px 0px;
{#                margin: 0px 10px 0px 40px;#}
                    margin: 0px 20px 0px 20px;

			}
{#			ul.timeline li .content pre {#}
{#				background-color: #3594cb;#}
{#				padding: 20px;#}
{#				color: #fff;#}
{#				font-size: 13px;#}
{#				line-height: 20px;#}
{#			}#}
{#			ul.timeline li.alt .content pre {#}
{#				background-color: #43B1F1;#}
{#			}#}


{#			a.number {#}
{#				position: absolute;#}
{#				background: url("http://fineui.com/res/img/version_dot.png") no-repeat scroll 0 0 transparent;#}
{#				width: 56px;#}
{#				height: 56px;#}
{#				left: 97px;#}
{#				line-height: 56px;#}
{#				text-align: center;#}
{#				color: #fff;#}
{#				font-size: 18px;#}
{#			}#}
		</style>


{#		<a href="/story/1">于谦</a>#}
{#		<a href="/add/story"><button >增加故事</button></a>#}
		<ul class="timeline" >
           
            {% for g in gallery%}
{#            <li>#}
{#                    <div class="time" >#}
{#                        <div>{{ g.create_time }}</div>#}
{#                    </div>#}
{#                    <div class="version">#}
{#                        <div id="mark_line_{{g.id}}" style="width: 20px ; height: 1px; background: url('/static/img/color_line.jpg') repeat-x scroll 0 0 transparent; ">#}
{#                        </div>#}
{#                    </div>#}
{#                    <div class="number" id="mark_{{g.id}}">{{g.id}}</div>#}
{#                    <div class="hole-top-right"></div>#}
{#                    <div class="content ">#}
{#                        <div class="row clear img-box gallery-node">#}
{#                            <div class="col-xs-6">#}
{#                                <a >#}
{#                                    <img src="{{ g.img_url }}" class="img-artwork">#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col-xs-6">#}
{#                                <a >#}
{#                                    <img src="{{ g.char_img_url }}" class="img-artwork ">#}
{#                                </a>#}
{#                            </div>#}
{#                            <div class="col-xs-12">#}
{##}
{#                                <div class="hole-bottom-left"></div>#}
{#                                <div class="hole-bottom-right"></div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#            </li>#}
        {% endfor %}
		</ul>

		<!--<div style="margin-left:180px;">-->
			<!--<button id="fetchNextData" class="btn btn-large btn-info" style="width:100%;">后二十条数据</button>-->
		<!--</div>-->
        <!--<br>-->
		<!--<br>-->
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="img_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">

         <div class="modal-header">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
                <p class="modal-title" id="myModalLabel">
                    <strong>Secret Gallery</strong>
                </p>
         </div>
         <div class="modal-body">


             <img id="img_modal_show" class="img-modal-show">
         </div>
{#         <div class="modal-footer">#}
{#            <button type="button" class="btn btn-default"#}
{#               data-dismiss="modal">关闭#}
{#            </button>#}
{#            <button type="button" class="btn btn-primary">#}
{#               提交更改#}
{#            </button>#}
{#         </div>#}
      </div><!-- /.modal-content -->
   </div><!-- /.modal -->
</div>

</body>

<script language="javascript" type="text/javascript">

//浏览器底部监测
var ajaxLoading = false;
var docNode = $(document);
 docNode.scroll(function() {
    if(docNode.height() - $(window).height() - docNode.scrollTop() < 10) {
        if(!ajaxLoading) {
            if (artwork_index < artwork_count)
                Get_Gallery_Show()
        }
    }
});



//分批次加载
var artwork_index = 0;
var artwork_count = 100;
function Get_Gallery_Show()
{
    ajaxLoading = true;
    $.ajax({
        type: "POST",
        url: '/blog/gallery/',
        data:{
            "open_id":"{{ open_id }}",
            "artwork_index":artwork_index
        },
        success:function(data,textStatus){
            console.log(data);
            console.log(JSON.parse(data['gallery_show']));

            //更改索引位置
            artwork_index = data['artwork_index'];
            artwork_count = data['artwork_count'];

            //解析画廊显示数据
            _gallery = JSON.parse(data['gallery_show']);
            /*  _gallery[i]['pk']
                _artwork = _gallery[i]['fields'];
                _artwork['create_time']
                _artwork['char_img_url']
                _artwork['img_url']
                _artwork['sketch_url']
            */
            for(var i = 0;i<_gallery.length;i++)
            {
                _artwork = _gallery[i]['fields'];
                _dom_li = [
                     '<li>',
                            '<div class="time" >',
                                '<div>'+_artwork['create_time']+'</div>',
                            '</div>',
                            '<div class="version">',
                                '<div id="mark_line_'+ _gallery[i]['pk'] +'" style="width: 20px ; height: 1px; background: url(\'/static/img/color_line.jpg\') repeat-x scroll 0 0 transparent; ">',
                                '</div>',
                            '</div>',
                            '<div class="number" id="mark_'+ _gallery[i]['pk'] + '">'+ _gallery[i]['pk'] +'</div>',
                            '<div class="hole-top-right"></div>',
                            '<div class="content ">',
                                '<div class="row clear img-box gallery-node">',
                                    '<div class="col-xs-6">',
                                        '<a >',
                                            '<img src="'+ _artwork['img_url'] +'" class="img-artwork">',
                                        '</a>',
                                    '</div>',
                                    '<div class="col-xs-6">',
                                        '<a >',
                                            '<img src="'+ _artwork['char_img_url'] +'" class="img-artwork ">',
                                        '</a>',
                                    '</div>',
                                    '<div class="col-xs-12">',
                                        '<div class="hole-bottom-left"></div>',
                                        '<div class="hole-bottom-right"></div>',
                                    '</div>',
                                '</div>',
                            '</div>',
                     '</li>',
                ].join('');

                $(".timeline").append(_dom_li);

                //mark数组，动态适应背景颜色
                mark_list.push('mark_'+ _gallery[i]['pk']);
                mark_line_list.push('mark_line_'+ _gallery[i]['pk']);
            }

            AddListenImg();

            //解绑loading状态
            ajaxLoading = false;
        },
        error:function(XMLHttpRequest, textStatus, errorThrown){
            alert(XMLHttpRequest.responseText);
        }
    });
}

var mark_list = [] ;
var mark_line_list = [] ;
var imgdefereds=[];

//监听图片下载
function AddListenImg(){
    $('img').each(function(){
     var dfd=$.Deferred();
     $(this).bind('load',function(){
     dfd.resolve();
     }).bind('error',function(){
     //图片加载错误，加入错误处理
     // dfd.resolve();
     });
     if(this.complete) setTimeout(function(){
     dfd.resolve();
     },1000);
     imgdefereds.push(dfd);
    })
    $.when.apply(null,imgdefereds).done(function(){
      ImgComplete();
    });
}

function ImgComplete(){
    for(var i=0;i<mark_list.length;i++)
    {
        //mark 圆 背景颜色自适应
        _dom = $("#"+mark_list[i]);
        _offsetY = _dom.offset().top;
        if (_offsetY > 990 )
            _offsetY = _offsetY % 990;
        _dom.css('background-position','0px -'+_offsetY +'px');

        //mark_line 线 背景颜色自适应
        _dom = $("#"+mark_line_list[i]);
        _offsetY = _dom.offset().top;
        if (_offsetY > 990 )
            _offsetY = _offsetY % 990;
        _dom.css('background-position','0px -'+_offsetY +'px');
    }

    $("img").click(function(){
        $('#img_modal').modal('show');
        $('#img_modal_show').prop('src',this.src);
    })
}




function Init(){
    Get_Gallery_Show();
}
Init();

{# Get_Gallery_Show();#}
{#Get_Gallery_Show();#}

</script>
</html>